# 服务端如何处理C10K
[如何处理10000 TCP连接](https://www.oschina.net/translate/c10k#top)
### 理论上限
服务端单机最大TCP连接数理论上限，系统会用一个四元组来标识一个TCP连接。

> {本机IP， 本机port， 对端IP， 对端port}

服务器通常固定在某个本地端口上监听，等待客户端的连接请求。因此，服务端端TCP连接四元组中只有对端（客户端）IP和port是可变的。因此，

> 最大TCP连接数 = 客户端IP数 ✖️ 客户端port数。

对IPV4，客户端IP数上限是2^32，客户端port数上限是2^16，也就是服务端单机最大TCP连接数，约为2^48。

当然，服务端最大并发TCP连接数远不能达到理论上限。

- 首先主要是文件描述符的限制，Socket都是文件，所以首先通过ulimit配置文件描述符的数目；
- 另一个限制是内存，按照socket的数据结构，每一个TCP连接都需要占用一定内存，操作系统的内存是有限制的。

资源有限的前提下，想要并发处理更多的TCP连接，需要降低每个连接消耗的资源数目。

### 1. 多进程方式
自己相当于代理，只负责监听新来的请求。一旦建立了一个连接，就会有一个已连接的socket文件，这时创建一个子进程，将基于已连接的socket文件的读写都交给子进程。

Linux下创建子进程使用fork函数，Linux内核中，会复制文件描述符的列表，也会复制内存空间，还会复制当前程序执行位置的记录。显然，复制的时候都在调用fork，只是根据返回值区分是父进程和子进程。返回值是0就是子进程；返回值是其他整数，就是父进程。

![进程复制过程](leanote://file/getImage?fileId=5b40457ec1953f7a13000000)

因为复制了文件描述符列表，而文件描述符都是指向整个内核统一的打开的文件列表的，因而父进程accept创建的已连接socket也是一个文件描述符，同样会被子进程获取。

接下来，子进程可以通过这个已连接的socket文件与客户端进行交互了。子进程处理完成之后，**父进程是可以通过子进程pid查看子进程是否完成，是否需要退出。**

### 2. 多线程方式
线程的创建和销毁比较重，采用多线程更加轻量级。Linux中通过pthread_create创建线程，内核中也是调用do_fork。不同的是，虽然新的线程会在task列表中新创建一项，但是很多资源，例如文件描述符和进程空间还是共享的，只是多出来一个引用而已。

![线程创建过程](leanote://file/getImage?fileId=5b404788c1953f7a13000001)

新创建的线程通过已连接的socket处理请求，达到并发处理的目的。

基于多进程和多线程模型都有问题，新来一个请求就需要分配一个进程或者线程。一台机器无法创建很多进程或线程，C10K问题，就是一台服务器维护10K个连接，就需要创建10K个进程或线程，操作系统是无法承受的。

### 3. IO多路复用，一个线程维护多个socket

socket是文件描述符，因而某个线程负责的所有socket，都放在一个文件描述符的集合fd_set中。select函数监听文件描述符集合是否发生变化。一旦发生变化，就需要依次查询每个文件描述符。发生变化的socket在fd_set对应的位都设置为1，表示socket可读或者可写，然后进行读写操作。然后再次调用select函数，查看下一轮的变化。

### 4. IO多路复用，epoll

select的问题在于轮询的方式查看socket的变化，效率较低。如果用事件通知方式处理会好很多。epoll在内核中的实现不是通过轮询的方式，而是通过注册callback函数的方式，当某个文件描述符发生变化的时候，就会主动通知。

![epoll](leanote://file/getImage?fileId=5b404a81c1953f7a13000002)

如图所示，假设进程打开了多个socket文件，现在通过epoll监听socket是否有事件发生。epoll_create创建一个epoll对象，也是一个文件，同样对应着打开文件列表中的一项。在这项里面有一个红黑树，在红黑树里面保存着这个epoll要监听的所有的socket。

当epoll_ctl添加一个socket时候，其实就是加入这个红黑树，同时红黑树节点只想一个结构，将这个结构挂在被监听的socket的事件列表中。当一个socket来了一个事件的时候，可以从这个列表中得到epoll对象，并调用call_back通知它？

这种通知方式使得监听的socket增加时，效率不会大幅度降低。同时监听的socket数目上限为系统定义的进程打开的最大文件描述符个数。因而，epoll被称为解决C10K问题的利器。
